{% extends "base.html" %}

{% block title %}Tag Generator - Emberburn{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üè∑Ô∏è OPC UA Tag Generator</h1>
    <p>Create, browse, and manage OPC UA / IEC 62541 industrial protocol tags</p>
</div>

<!-- Stat Cards -->
<div class="card-grid">
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span>üìä</span>
                Total Tags
            </div>
        </div>
        <div class="card-value" id="total-tags-count">0</div>
        <div class="card-subtitle">Registered in address space</div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span>üü¢</span>
                Server Status
            </div>
        </div>
        <div class="card-value" id="server-uptime" style="font-size: 24px;">--</div>
        <div class="card-subtitle">OPC UA uptime</div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span>üì°</span>
                Connected Clients
            </div>
        </div>
        <div class="card-value" id="connected-clients">0</div>
        <div class="card-subtitle">Active OPC UA sessions</div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-header">
        <div class="card-title">Quick Actions</div>
    </div>
    <div class="action-bar">
        <button class="btn btn-primary" onclick="TagGenerator.showCreateModal()">+ New Tag</button>
        <button class="btn btn-secondary" onclick="TagGenerator.showImportModal()">üìÅ Import CSV/JSON</button>
        <button class="btn btn-secondary" onclick="TagGenerator.exportTags('csv')">üì§ Export CSV</button>
        <button class="btn btn-secondary" onclick="TagGenerator.exportTags('json')">üì§ Export JSON</button>
        <button class="btn btn-secondary" onclick="TagGenerator.showTemplateModal()">üìã Templates</button>
    </div>
</div>

<!-- Tag Table -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Tags</div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="tag-gen-search" placeholder="Search tags..." class="form-input"
                style="width: 250px;">
        </div>
    </div>
    <div class="table-container" style="border: none;">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Value</th>
                    <th>Quality</th>
                    <th>Units</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tag-gen-table">
                <tr>
                    <td colspan="6" class="loading">Loading tags...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Create Tag Modal -->
<div id="create-tag-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Tag</h2>
            <button class="btn btn-secondary" onclick="TagGenerator.hideCreateModal()"
                style="padding: 4px 10px;">‚úï</button>
        </div>
        <form id="create-tag-form" onsubmit="TagGenerator.handleCreateTag(event)">
            <div class="form-group">
                <label class="form-label">Tag Name *</label>
                <input type="text" name="name" class="form-input" placeholder="e.g. Production.Line1.Motor1.Speed"
                    required>
            </div>
            <div class="form-group">
                <label class="form-label">Display Name</label>
                <input type="text" name="displayName" class="form-input" placeholder="e.g. Motor 1 Speed">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" name="description" class="form-input"
                    placeholder="e.g. Main drive motor speed in RPM">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Data Type *</label>
                    <select name="type" class="form-select" required>
                        <option value="float">Float</option>
                        <option value="int">Int32</option>
                        <option value="bool">Boolean</option>
                        <option value="string">String</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Initial Value *</label>
                    <input type="text" name="initial_value" class="form-input" placeholder="0.0" required>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Engineering Units</label>
                    <input type="text" name="units" class="form-input" placeholder="e.g. RPM, ¬∞C, bar">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <input type="text" name="category" class="form-input" placeholder="e.g. Process, Motor, Sensor">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Simulate</label>
                    <select name="simulate" class="form-select">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Simulation Type</label>
                    <select name="simulation_type" class="form-select">
                        <option value="static">Static</option>
                        <option value="random">Random</option>
                        <option value="increment">Increment</option>
                        <option value="sine">Sine Wave</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Access Level</label>
                    <select name="access" class="form-select">
                        <option value="readwrite">Read/Write</option>
                        <option value="readonly">Read Only</option>
                    </select>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Min Value</label>
                    <input type="number" name="min" class="form-input" step="any" placeholder="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Max Value</label>
                    <input type="number" name="max" class="form-input" step="any" placeholder="100">
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="TagGenerator.hideCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Tag</button>
            </div>
        </form>
    </div>
</div>

<!-- Import Modal -->
<div id="import-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Import Tags</h2>
            <button class="btn btn-secondary" onclick="TagGenerator.hideImportModal()"
                style="padding: 4px 10px;">‚úï</button>
        </div>
        <div class="form-group">
            <label class="form-label">Upload CSV or JSON file</label>
            <input type="file" id="import-file" class="form-input" accept=".csv,.json">
        </div>
        <div id="import-preview" style="display: none; margin-top: 15px;">
            <h3 style="margin-bottom: 10px; color: var(--ember-red);">Preview</h3>
            <div class="table-container">
                <table>
                    <thead id="import-preview-head"></thead>
                    <tbody id="import-preview-body"></tbody>
                </table>
            </div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="TagGenerator.hideImportModal()">Cancel</button>
            <button class="btn btn-primary" onclick="TagGenerator.confirmImport()" id="confirm-import-btn"
                disabled>Import Tags</button>
        </div>
    </div>
</div>

<!-- Template Modal -->
<div id="template-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Tag Templates</h2>
            <button class="btn btn-secondary" onclick="TagGenerator.hideTemplateModal()"
                style="padding: 4px 10px;">‚úï</button>
        </div>
        <p style="color: var(--text-sub); margin-bottom: 15px;">Select a preset template to quickly create a set of
            tags:</p>
        <div id="template-list" class="template-list">
            <!-- Templates will be populated by JS -->
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="TagGenerator.hideTemplateModal()">Close</button>
        </div>
    </div>
</div>

<!-- Write Value Modal -->
<div id="write-value-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2>Write Value</h2>
            <button class="btn btn-secondary" onclick="TagGenerator.hideWriteModal()"
                style="padding: 4px 10px;">‚úï</button>
        </div>
        <div class="form-group">
            <label class="form-label">Tag: <span id="write-tag-name" style="color: var(--ember-red);"></span></label>
            <input type="text" id="write-value-input" class="form-input" placeholder="Enter new value...">
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
            <button class="btn btn-secondary" onclick="TagGenerator.hideWriteModal()">Cancel</button>
            <button class="btn btn-primary" onclick="TagGenerator.confirmWriteValue()">Write</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    /* Tag Generator ‚Äî Modal styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 25px;
        width: 90%;
        max-width: 650px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h2 {
        color: var(--ember-red);
        font-size: 1.3em;
    }

    /* Template list */
    .template-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .template-item {
        background: var(--portal-bg);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 15px;
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .template-item:hover {
        border-color: var(--ember-red);
    }

    .template-item h3 {
        color: var(--text-main);
        font-size: 1em;
        margin-bottom: 5px;
    }

    .template-item p {
        color: var(--text-sub);
        font-size: 0.85em;
    }

    .template-item .tag-count {
        color: var(--ember-red);
        font-weight: 600;
        font-size: 0.85em;
        margin-top: 5px;
    }

    /* Quality badges in table */
    .quality-good {
        color: var(--success-green);
        font-weight: 600;
    }

    .quality-stale {
        color: var(--warning-yellow);
        font-weight: 600;
    }

    .quality-bad {
        color: var(--error-red);
        font-weight: 600;
    }

    /* Tag action buttons */
    .tag-actions {
        display: flex;
        gap: 4px;
    }

    .tag-actions .btn {
        padding: 4px 8px;
        font-size: 13px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('web_ui.static', filename='js/tag_generator.js') }}"></script>
{% endblock %}